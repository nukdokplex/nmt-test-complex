!function(f,i,r){var e="ontouchstart"in r.documentElement,t=e?"touchstart":"mousedown",l=e?"touchmove":"mousemove",s=e?"touchend":"mouseup";e&&f.each("touchstart touchmove touchend".split(" "),function(t,e){f.event.fixHooks[e]=f.event.mouseHooks}),f(r).ready(function(){function t(t){for(var e={},a=t.match(/([^;:]+)/g)||[];a.length;)e[a.shift()]=a.shift().trim();return e}f("table").each(function(){"dnd"==f(this).data("table")&&f(this).tableDnD({onDragStyle:f(this).data("ondragstyle")&&t(f(this).data("ondragstyle"))||null,onDropStyle:f(this).data("ondropstyle")&&t(f(this).data("ondropstyle"))||null,onDragClass:null==f(this).data("ondragclass")?"tDnD_whileDrag":f(this).data("ondragclass"),onDrop:f(this).data("ondrop")&&new Function("table","row",f(this).data("ondrop")),onDragStart:f(this).data("ondragstart")&&new Function("table","row",f(this).data("ondragstart")),scrollAmount:f(this).data("scrollamount")||5,sensitivity:f(this).data("sensitivity")||10,hierarchyLevel:f(this).data("hierarchylevel")||0,indentArtifact:f(this).data("indentartifact")||'<div class="indent">&nbsp;</div>',autoWidthAdjust:f(this).data("autowidthadjust")||!0,autoCleanRelations:f(this).data("autocleanrelations")||!0,jsonPretifySeparator:f(this).data("jsonpretifyseparator")||"\t",serializeRegexp:f(this).data("serializeregexp")&&new RegExp(f(this).data("serializeregexp"))||/[^\-]*$/,serializeParamName:f(this).data("serializeparamname")||!1,dragHandle:f(this).data("draghandle")||null})})}),jQuery.tableDnD={currentTable:null,dragObject:null,mouseOffset:null,oldX:0,oldY:0,build:function(t){return this.each(function(){this.tableDnDConfig=f.extend({onDragStyle:null,onDropStyle:null,onDragClass:"tDnD_whileDrag",onDrop:null,onDragStart:null,scrollAmount:5,sensitivity:10,hierarchyLevel:0,indentArtifact:'<div class="indent">&nbsp;</div>',autoWidthAdjust:!0,autoCleanRelations:!0,jsonPretifySeparator:"\t",serializeRegexp:/[^\-]*$/,serializeParamName:!1,dragHandle:null},t||{}),f.tableDnD.makeDraggable(this),this.tableDnDConfig.hierarchyLevel&&f.tableDnD.makeIndented(this)}),this},makeIndented:function(t){var e,a,n=t.tableDnDConfig,i=t.rows,r=f(i).first().find("td:first")[0],l=0,s=0;if(f(t).hasClass("indtd"))return null;a=f(t).addClass("indtd").attr("style"),f(t).css({whiteSpace:"nowrap"});for(var o=0;o<i.length;o++)s<f(i[o]).find("td:first").text().length&&(s=f(i[o]).find("td:first").text().length,e=o);for(f(r).css({width:"auto"}),o=0;o<n.hierarchyLevel;o++)f(i[e]).find("td:first").prepend(n.indentArtifact);for(r&&f(r).css({width:r.offsetWidth}),a&&f(t).css(a),o=0;o<n.hierarchyLevel;o++)f(i[e]).find("td:first").children(":first").remove();return n.hierarchyLevel&&f(i).each(function(){(l=f(this).data("level")||0)<=n.hierarchyLevel&&f(this).data("level",l)||f(this).data("level",0);for(var t=0;t<f(this).data("level");t++)f(this).find("td:first").prepend(n.indentArtifact)}),this},makeDraggable:function(e){var a=e.tableDnDConfig;a.dragHandle&&f(a.dragHandle,e).each(function(){f(this).bind(t,function(t){return f.tableDnD.initialiseDrag(f(this).parents("tr")[0],e,this,t,a),!1})})||f(e.rows).each(function(){f(this).hasClass("nodrag")||f(this).bind(t,function(t){if("TD"==t.target.tagName)return f.tableDnD.initialiseDrag(this,e,this,t,a),!1}).css("cursor","move")})},currentOrder:function(){var t=this.currentTable.rows;return f.map(t,function(t){return(f(t).data("level")+t.id).replace(/\s/g,"")}).join("")},initialiseDrag:function(t,e,a,n,i){this.dragObject=t,this.currentTable=e,this.mouseOffset=this.getMouseOffset(a,n),this.originalOrder=this.currentOrder(),f(r).bind(l,this.mousemove).bind(s,this.mouseup),i.onDragStart&&i.onDragStart(e,a)},updateTables:function(){this.each(function(){this.tableDnDConfig&&f.tableDnD.makeDraggable(this)})},mouseCoords:function(t){return e?{x:event.changedTouches[0].clientX,y:event.changedTouches[0].clientY}:t.pageX||t.pageY?{x:t.pageX,y:t.pageY}:{x:t.clientX+r.body.scrollLeft-r.body.clientLeft,y:t.clientY+r.body.scrollTop-r.body.clientTop}},getMouseOffset:function(t,e){var a,n;return e=e||i.event,n=this.getPosition(t),{x:(a=this.mouseCoords(e)).x-n.x,y:a.y-n.y}},getPosition:function(t){var e=0,a=0;for(0==t.offsetHeight&&(t=t.firstChild);t.offsetParent;)e+=t.offsetLeft,a+=t.offsetTop,t=t.offsetParent;return{x:e+=t.offsetLeft,y:a+=t.offsetTop}},autoScroll:function(t){var e=this.currentTable.tableDnDConfig,a=i.pageYOffset,n=i.innerHeight?i.innerHeight:r.documentElement.clientHeight?r.documentElement.clientHeight:r.body.clientHeight;r.all&&(void 0!==r.compatMode&&"BackCompat"!=r.compatMode?a=r.documentElement.scrollTop:void 0!==r.body&&(a=r.body.scrollTop)),t.y-a<e.scrollAmount&&i.scrollBy(0,-e.scrollAmount)||n-(t.y-a)<e.scrollAmount&&i.scrollBy(0,e.scrollAmount)},moveVerticle:function(t,e){0!=t.vertical&&e&&this.dragObject!=e&&this.dragObject.parentNode==e.parentNode&&(t.vertical<0&&this.dragObject.parentNode.insertBefore(this.dragObject,e.nextSibling)||0<t.vertical&&this.dragObject.parentNode.insertBefore(this.dragObject,e))},moveHorizontal:function(t,e){var a,n=this.currentTable.tableDnDConfig;if(!n.hierarchyLevel||0==t.horizontal||!e||this.dragObject!=e)return null;a=f(e).data("level"),0<t.horizontal&&0<a&&f(e).find("td:first").children(":first").remove()&&f(e).data("level",--a),t.horizontal<0&&a<n.hierarchyLevel&&f(e).prev().data("level")>=a&&f(e).children(":first").prepend(n.indentArtifact)&&f(e).data("level",++a)},mousemove:function(t){var e,a,n,i,r,l=f(f.tableDnD.dragObject),s=f.tableDnD.currentTable.tableDnDConfig;return t&&t.preventDefault(),f.tableDnD.dragObject&&("touchmove"==t.type&&event.preventDefault(),s.onDragClass&&l.addClass(s.onDragClass)||l.css(s.onDragStyle),i=(a=f.tableDnD.mouseCoords(t)).x-f.tableDnD.mouseOffset.x,r=a.y-f.tableDnD.mouseOffset.y,f.tableDnD.autoScroll(a),e=f.tableDnD.findDropTargetRow(l,r),n=f.tableDnD.findDragDirection(i,r),f.tableDnD.moveVerticle(n,e),f.tableDnD.moveHorizontal(n,e)),!1},findDragDirection:function(t,e){var a=this.currentTable.tableDnDConfig.sensitivity,n=this.oldX,i=this.oldY,r={horizontal:n-a<=t&&t<=n+a?0:n<t?-1:1,vertical:i-a<=e&&e<=i+a?0:i<e?-1:1};return 0!=r.horizontal&&(this.oldX=t),0!=r.vertical&&(this.oldY=e),r},findDropTargetRow:function(t,e){for(var a=0,n=this.currentTable.rows,i=this.currentTable.tableDnDConfig,r=0,l=null,s=0;s<n.length;s++)if(l=n[s],r=this.getPosition(l).y,a=parseInt(l.offsetHeight)/2,0==l.offsetHeight&&(r=this.getPosition(l.firstChild).y,a=parseInt(l.firstChild.offsetHeight)/2),r-a<e&&e<r+a)return t.is(l)||i.onAllowDrop&&!i.onAllowDrop(t,l)||f(l).hasClass("nodrop")?null:l;return null},processMouseup:function(){var t=this.currentTable.tableDnDConfig,e=this.dragObject,a=0,n=0;if(!this.currentTable||!e)return null;f(r).unbind(l,this.mousemove).unbind(s,this.mouseup),t.hierarchyLevel&&t.autoCleanRelations&&f(this.currentTable.rows).first().find("td:first").children().each(function(){(n=f(this).parents("tr:first").data("level"))&&f(this).parents("tr:first").data("level",--n)&&f(this).remove()})&&1<t.hierarchyLevel&&f(this.currentTable.rows).each(function(){if(1<(n=f(this).data("level")))for(a=f(this).prev().data("level");a+1<n;)f(this).find("td:first").children(":first").remove(),f(this).data("level",--n)}),t.onDragClass&&f(e).removeClass(t.onDragClass)||f(e).css(t.onDropStyle),this.dragObject=null,t.onDrop&&this.originalOrder!=this.currentOrder()&&f(e).hide().fadeIn("fast")&&t.onDrop(this.currentTable,e),this.currentTable=null},mouseup:function(t){return t&&t.preventDefault(),f.tableDnD.processMouseup(),!1},jsonize:function(t){var e=this.currentTable;return t?JSON.stringify(this.tableData(e),null,e.tableDnDConfig.jsonPretifySeparator):JSON.stringify(this.tableData(e))},serialize:function(){return f.param(this.tableData(this.currentTable))},serializeTable:function(t){for(var e="",a=t.tableDnDConfig.serializeParamName||t.id,n=t.rows,i=0;i<n.length;i++){0<e.length&&(e+="&");var r=n[i].id;r&&t.tableDnDConfig&&t.tableDnDConfig.serializeRegexp&&(e+=a+"[]="+(r=r.match(t.tableDnDConfig.serializeRegexp)[0]))}return e},serializeTables:function(){var t=[];return f("table").each(function(){this.id&&t.push(f.param(this.tableData(this)))}),t.join("&")},tableData:function(t){var e,a,n,i,r=t.tableDnDConfig,l=[],s=0,o=0,d=null,h={};if(!((t=t||this.currentTable)&&t.id&&t.rows&&t.rows.length))return{error:{code:500,message:"Not a valid table, no serializable unique id provided."}};i=r.autoCleanRelations&&t.rows||f.makeArray(t.rows),e=function(t){return t&&r&&r.serializeRegexp?t.match(r.serializeRegexp)[0]:t},h[n=a=r.serializeParamName||t.id]=[],!r.autoCleanRelations&&f(i[0]).data("level")&&i.unshift({id:"undefined"});for(var u=0;u<i.length;u++)if(r.hierarchyLevel){if(0==(o=f(i[u]).data("level")||0))n=a,l=[];else if(s<o)l.push([n,s]),n=e(i[u-1].id);else if(o<s)for(var c=0;c<l.length;c++)l[c][1]==o&&(n=l[c][0]),l[c][1]>=s&&(l[c][1]=0);s=o,f.isArray(h[n])||(h[n]=[]),(d=e(i[u].id))&&h[n].push(d)}else(d=e(i[u].id))&&h[n].push(d);return h}},jQuery.fn.extend({tableDnD:f.tableDnD.build,tableDnDUpdate:f.tableDnD.updateTables,tableDnDSerialize:f.proxy(f.tableDnD.serialize,f.tableDnD),tableDnDSerializeAll:f.tableDnD.serializeTables,tableDnDData:f.proxy(f.tableDnD.tableData,f.tableDnD)})}(jQuery,window,window.document);